#!/usr/bin/bash

ALLIANCE_SUBDIR=".alliance"
MISSING_FILE="$ALLIANCE_SUBDIR/missing_wheels.txt"
AVAIL_FILE="$ALLIANCE_SUBDIR/available_wheels.txt"
REQ_FILE="$ALLIANCE_SUBDIR/requirements.txt"
LOCAL_WHEELS_DIR="$ALLIANCE_SUBDIR/local-wheels"

generate_requirements_files() {
  # Copy requirements or create one from pyproject.toml if none exist
  if [ -f "requirements.txt" ]; then
    cp requirements.txt "$REQ_FILE"
  else
    get_deps --output "$REQ_FILE"
  fi

  if [ ! -s "$REQ_FILE" ]; then
    echo "Error: $REQ_FILE is empty or does not exist." >&2
    exit 1
  fi

  avail_wheels --raw -r "$REQ_FILE" --not-available-only > "$MISSING_FILE"
  avail_wheels -r "$REQ_FILE" --format plain | awk 'NR > 1 {print $1}' > "$AVAIL_FILE"
}

check_requirements_files() {
  if [ ! -f "$REQ_FILE" ] || [ ! -s "$REQ_FILE" ]; then
    echo "Warning: Requirements files are missing or empty. Download/install may fail." >&2
    return 1
  fi
  return 0
}

download_missing_wheels() {
  check_requirements_files
  if [ -s "$MISSING_FILE" ]; then
    mkdir -p "$LOCAL_WHEELS_DIR"
    pip download --no-deps -r "$MISSING_FILE" -d "$LOCAL_WHEELS_DIR"
  fi
}

install_wheels() {
  check_requirements_files
  if [ -s "$AVAIL_FILE" ]; then
    pip install --no-index -r "$AVAIL_FILE"
  fi

  if [ -s "$MISSING_FILE" ]; then
    pip install "$LOCAL_WHEELS_DIR"/*
  fi
}

# Parse command line arguments
FORCE=false
SKIP_DOWNLOAD=false
DO_INSTALL=false
while [[ $# -gt 0 ]]; do
  case $1 in
    --help|-h)
      echo "Usage: pyinstall [OPTIONS]"
      echo ""
      echo "Generate requirements files and optionally download/install Python packages."
      echo ""
      echo "Options:"
      echo "  -h, --help         Show this help message and exit"
      echo "  -f, --force        Overwrite existing .alliance directory if not empty"
      echo "  --skip-download    Skip downloading missing wheels"
      echo "  --install          Install the downloaded wheels"
      exit 0
      ;;
    --force|-f)
      FORCE=true
      shift
      ;;
    --skip-download)
      SKIP_DOWNLOAD=true
      shift
      ;;
    --install)
      DO_INSTALL=true
      shift
      ;;
    *)
      echo "Unknown option: $1" >&2
      echo "Usage: pyinstall [--force|-f] [--skip-download] [--install]" >&2
      exit 1
      ;;
  esac
done

# Check if .alliance directory exists
ALLIANCE_EXISTS=false
if [ -e "$ALLIANCE_SUBDIR" ]; then
  # Check if it's non-empty
  if [ -n "$(ls -A "$ALLIANCE_SUBDIR" 2>/dev/null)" ]; then
    ALLIANCE_EXISTS=true
    if [ "$FORCE" = false ]; then
      # If alliance exists and both download and install are skipped, show error
      if [ "$SKIP_DOWNLOAD" = true ] && [ "$DO_INSTALL" = false ]; then
        echo "Error: $ALLIANCE_SUBDIR directory exists and neither download nor install are enabled." >&2
        echo "Use --force to re-generate the alliance subdirectory." >&2
        exit 1
      fi
    fi
  fi
else
  # Create .alliance directory if it doesn't exist
  mkdir "$ALLIANCE_SUBDIR"
fi

# Only generate requirements files if alliance doesn't exist or force is set
if [ "$ALLIANCE_EXISTS" = false ] || [ "$FORCE" = true ]; then
  generate_requirements_files
fi

if [ "$SKIP_DOWNLOAD" = false ]; then
  download_missing_wheels
fi

if [ "$DO_INSTALL" = true ]; then
  install_wheels
fi
