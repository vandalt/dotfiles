#!/usr/bin/env bash
set -euo pipefail

# Script to find ALL missing dependencies when installing with --no-index
# Uses pip-compile or direct parsing to get full dependency tree

PACKAGE_PATH="."
FIND_LINKS=""
OUTPUT_FILE="missing_dependencies.txt"

usage() {
  cat <<EOF
Usage: $0 [OPTIONS]

Find ALL missing dependencies when installing with --no-index.

NOTE: I am keeping this in case it is useful, but get_deps and avail_wheels should be better most of the time.

OPTIONS:
    -p, --package-path PATH    Path to package to install (default: .)
    -f, --find-links PATH      Path to local package directory
    -o, --output FILE          Output file (default: missing_dependencies.txt)
    -h, --help                 Show this help message

EXAMPLES:
    # Basic usage
    $0

    # With local package directory
    $0 --find-links ./local_packages

    # Custom output file
    $0 -o my_missing_deps.txt
EOF
  exit 0
}

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
  -p | --package-path)
    PACKAGE_PATH="$2"
    shift 2
    ;;
  -f | --find-links)
    FIND_LINKS="$2"
    shift 2
    ;;
  -o | --output)
    OUTPUT_FILE="$2"
    shift 2
    ;;
  -h | --help)
    usage
    ;;
  *)
    echo "Unknown option: $1"
    usage
    ;;
  esac
done

# Check if output file already exists
if [[ -f "${OUTPUT_FILE}" ]]; then
  echo "ERROR: Output file '${OUTPUT_FILE}' already exists." >&2
  echo "Please remove it or specify a different output file with -o" >&2
  exit 1
fi

echo "============================================================"
echo "Finding ALL missing dependencies for HPC environment"
echo "============================================================"

# Step 1: Get all required packages (with dependencies resolved)
echo ""
echo "Step 1: Resolving full dependency tree..."
echo "------------------------------------------------------------"

TMPDIR=$(mktemp -d)
ALLPKGS="${TMPDIR}/all_packages.txt"
AVAILABLE="${TMPDIR}/available.txt"

# Get all packages that would be installed (full dependency tree)
# Using --dry-run with normal index to get complete list
if ! pip install --dry-run -e "${PACKAGE_PATH}" 2>&1 | tee /dev/stderr |
  grep -E '(Would install|Requirement already satisfied)' |
  grep -oP '\b[a-zA-Z0-9][a-zA-Z0-9._-]*(?=-[0-9])' |
  sort -u >"${ALLPKGS}"; then
  echo "ERROR: pip install --dry-run failed" >&2
  rm -rf "${TMPDIR}"
  exit 1
fi

# If that didn't work, try alternative approach using pipdeptree or parsing metadata
if [[ ! -s "${ALLPKGS}" ]]; then
  echo "ERROR: Failed to resolve dependency tree" >&2
  echo "The file ${ALLPKGS} is empty or does not exist" >&2
  rm -rf "${TMPDIR}"
  exit 1
fi

NUM_TOTAL=$(wc -l <"${ALLPKGS}" 2>/dev/null || echo 0)
echo "Found ${NUM_TOTAL} total packages (including dependencies)"

# Step 2: Check which packages are available locally
echo ""
echo "Step 2: Checking local availability..."
echo "------------------------------------------------------------"

# Create empty file using > to make sure it's empty
true >"${AVAILABLE}"

while IFS= read -r pkg; do
  [[ -z "${pkg}" ]] && continue

  # Try to find package with --no-index
  PIP_CMD="pip install --dry-run --no-index ${pkg}"
  if [[ -n "${FIND_LINKS}" ]]; then
    PIP_CMD="${PIP_CMD} --find-links ${FIND_LINKS}"
  fi

  if ${PIP_CMD} >/dev/null 2>&1; then
    echo "${pkg}" >>"${AVAILABLE}"
    echo "  ✓ ${pkg}"
  else
    echo "  ✗ ${pkg}"
  fi
done <"${ALLPKGS}"

# Step 3: Find missing packages (difference)
echo ""
echo "Step 3: Identifying missing packages..."
echo "------------------------------------------------------------"

true >"${OUTPUT_FILE}"
comm -23 "${ALLPKGS}" "${AVAILABLE}" >"${OUTPUT_FILE}"

# Clean up temp files
rm -rf "${TMPDIR}"

# Check results
if [[ ! -s "${OUTPUT_FILE}" ]]; then
  echo ""
  echo "============================================================"
  echo "✓ All dependencies are available locally!"
  echo "============================================================"
  rm -f "${OUTPUT_FILE}"
  exit 0
fi

# Display results
NUM_MISSING=$(wc -l <"${OUTPUT_FILE}")
NUM_AVAILABLE=$(wc -l <"${AVAILABLE}" 2>/dev/null || echo 0)

echo ""
echo "============================================================"
echo "Summary:"
echo "  Total packages needed: ${NUM_TOTAL}"
echo "  Available locally: ${NUM_AVAILABLE}"
echo "  Missing: ${NUM_MISSING}"
echo "============================================================"
echo ""
echo "Missing dependencies:"
while IFS= read -r pkg; do
  echo "  - ${pkg}"
done <"${OUTPUT_FILE}"

echo ""
echo "Missing dependencies saved to: ${OUTPUT_FILE}"
echo "To pre-download these packages, use"
echo "  pip download --no-deps -r ${OUTPUT_FILE} -d ./local-wheels/"

exit 0

